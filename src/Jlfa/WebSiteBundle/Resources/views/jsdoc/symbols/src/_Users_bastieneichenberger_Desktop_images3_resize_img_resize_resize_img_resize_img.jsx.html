<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="TOKN">﻿</span><span class="TOKN">#</span><span class="NAME">target</span><span class="WHIT"> </span><span class="NAME">indesign</span><span class="WHIT"></span><span class="TOKN">#</span><span class="NAME">include</span><span class="WHIT"> </span><span class="STRN">"includes/Log.jsx"</span><span class="WHIT"></span><span class="TOKN">#</span><span class="NAME">include</span><span class="WHIT"> </span><span class="STRN">"includes/Dialog_box.jsx"</span><span class="WHIT"></span><span class="TOKN">#</span><span class="NAME">include</span><span class="WHIT"> </span><span class="STRN">"includes/Tools.jsx"</span><span class="WHIT"></span><span class="TOKN">#</span><span class="NAME">include</span><span class="WHIT"> </span><span class="STRN">"includes/Picture_tools.jsx"</span><span class="WHIT"></span><span class="TOKN">#</span><span class="NAME">include</span><span class="WHIT"> </span><span class="STRN">"includes/Document_tools.jsx"</span><span class="WHIT"></span><span class="TOKN">#</span><span class="NAME">include</span><span class="WHIT"> </span><span class="STRN">"includes/PS/Photoshop_library.jsx"</span><span class="WHIT"></span><span class="COMM">/** * @fileoverview InDesign JavaScript Extension to reduce all links to 100% in the document* all images are resized in Photoshop, the document is copied on the desktop with package function* this script use the shell and work only on mac OS X &lt;a href="http://www.images3.ch">www.image3.ch&lt;/a>.&lt;/br>* this script require the following class: &lt;/br>* &lt;code>* include Log.jsx &lt;/br>* include Dialog_box.jsx &lt;/br>* include Tools.jsx &lt;/br>* include Picture_tools.jsx &lt;/br>* include Document_tools.jsx &lt;/br>* include Photoshop_library.jsx* &lt;/code> * @author Bastien Eichenberger * @version 1.0 * @date 10.09.2013 **/</span><span class="WHIT"></span><span class="COMM">/** * SAVE_DIR, the result script directories **/</span><span class="WHIT"></span><span class="KEYW">const</span><span class="WHIT"> </span><span class="NAME">SAVE_DIR</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"~/Desktop"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"/indd_resize_script"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="COMM">/** * SCRIPT_DIR, the script directories **/</span><span class="WHIT"></span><span class="KEYW">const</span><span class="WHIT"> </span><span class="NAME">SCRIPT_DIR</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">File</span><span class="PUNC">(</span><span class="NAME">$.fileName</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="COMM">/** * LOG_DIR, the error log directories **/</span><span class="WHIT"></span><span class="KEYW">const</span><span class="WHIT"> </span><span class="NAME">LOG_DIR</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">SCRIPT_DIR</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"/log"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="COMM">/*** doc, the original document**/</span><span class="WHIT"></span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">doc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"></span><span class="COMM">/*** doc_name, the document name**/</span><span class="WHIT"></span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">doc_name</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT"></span><span class="KEYW">try</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">user_preferences</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">app.preferences</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">// at start we want to display dialog box to save document</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">app.scriptPreferences.userInteractionLevel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">UserInteractionLevels.INTERACT_WITH_ALL</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">main</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="KEYW">catch</span><span class="PUNC">(</span><span class="NAME">ex</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">logger</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Log</span><span class="PUNC">(</span><span class="NAME">File</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">LOG_DIR</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"/log.txt"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">logger.error</span><span class="PUNC">(</span><span class="STRN">"document name: "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">doc_name</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="STRN">" – error: "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ex.message</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"  – error line: "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">ex.line</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">exit</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="KEYW">finally</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">// always restore the user preferences</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">app.preferences</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">user_preferences</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/** * Process the script, this function check if the system is Mac os X and check the version * The document must have been saved befor the script is running **/</span><span class="WHIT"></span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">main</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">// if the system is window -> Error</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">File.fs</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"Windows"</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"ce script fonctionne uniquement sur mac OS X"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">//if version is not CS6. CS5.5 -> Error</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">app.version</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="STRN">"8.0"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">app.version</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="STRN">"9.0"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">app.version</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="STRN">"7.5"</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">app.version</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="STRN">"8.0"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">app.version</span><span class="WHIT"> </span><span class="PUNC">>=</span><span class="WHIT"> </span><span class="STRN">"7.0"</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">app.version</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="STRN">"7.5"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="STRN">"ce script fonctionne sur les versions d'indesign 8.0 (CS6), 7.5 (CS5.5), 7.0 (CS5)"</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">+</span><span class="STRN">"veuillez contacter l'administrateur si vous souhaitez utiliser ce script sur une autre version"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">// a indesign doc must be open</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="PUNC">!</span><span class="PUNC">(</span><span class="NAME">app.documents.length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">alert</span><span class="PUNC">(</span><span class="STRN">"vous devez ouvrir un document pour lancer le script"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">exit</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">//then open photoshop</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">open_photoshop</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">doc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">app.activeDocument</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">doc_name</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">doc.name</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">//the doc must be saved</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">doc.saved</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">save_doc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">confirm</span><span class="PUNC">(</span><span class="STRN">"le document doit être sauvé pour continuer le script. Voulez-vous enregistrer le document sous"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">save_doc</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">//If you do not provide a file name, InDesign displays the Save dialog box</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">doc.save</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">run_script</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">alert</span><span class="PUNC">(</span><span class="STRN">"le script a été annulé"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">exit</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">     </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">     </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">         </span><span class="COMM">// if the doc is already saved, is it modified?</span><span class="WHIT"></span><span class="WHIT">         </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">doc.modified</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">modified_doc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">confirm</span><span class="PUNC">(</span><span class="STRN">"le document doit être sauvé pour continuer le script. Voulez-vous enregistrer les modifications"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">             </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">modified_doc</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                 </span><span class="NAME">doc.save</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                 </span><span class="NAME">run_script</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">             </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">             </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">alert</span><span class="PUNC">(</span><span class="STRN">"le script a été annulé"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">exit</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">             </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">         </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">         </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">run_script</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">         </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/** * this function execute the script, if links are out of date or a link is missing the script will be canceled * all changement are written in the log file * a link must be used only 1 time to been resized**/</span><span class="WHIT"></span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">run_script</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">// this script can't be interrupted by a dialog box (font missing, missmatch color profile etc.)</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">app.scriptPreferences.userInteractionLevel</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">UserInteractionLevels.NEVER_INTERACT</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">Document_tools.check_outOfDate_link</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">doc</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">Document_tools.check_is_missing_link</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">doc</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">alert</span><span class="PUNC">(</span><span class="STRN">"le script contient un ou plusieurs lien(s) manquant(s) ou modifiés(s), veuillez mettre à jour les liens puis recommencer."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">exit</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">window</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Dialog_box</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">results</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">window.show</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">// the user click run script and init proprieties</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">results</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">number_of_link_modified</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// package the doc, open the new doc</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">doc_package_str</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Document_tools.save_with_package</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">doc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">SAVE_DIR</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">doc.close</span><span class="PUNC">(</span><span class="NAME">SaveOptions.NO</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">doc_package</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">app.open</span><span class="PUNC">(</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">File</span><span class="PUNC">(</span><span class="NAME">doc_package_str</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// folder after the package</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">folder_package</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">File</span><span class="PUNC">(</span><span class="NAME">doc_package_str</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// rapport logger</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rapport_logger</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Log</span><span class="PUNC">(</span><span class="NAME">File</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">folder_package</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"/rapport.txt"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="WHIT"></span><span class="WHIT">            </span><span class="COMM">// if the user want to copy duplicated links copy all links</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">results.split_duplicated_links</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="COMM">// get all links from package doc</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">array_all_links</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">doc_package.links</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="COMM">// duplicate links who are used many times in doc</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">duplicated_links</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="COMM">// split file who are used many time</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">array_all_links.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">current_link</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">array_all_links</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">is_valid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">is_link_valid</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">current_link</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">results.array_of_ignored_picture</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="COMM">//modifie only a valid link</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">is_valid</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">use_number</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Document_tools.is_link_used_many_time</span><span class="PUNC">(</span><span class="NAME">current_link</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">doc_package</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">use_number</span><span class="WHIT">  </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="NAME">duplicated_links.push</span><span class="PUNC">(</span><span class="NAME">current_link</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sorted_array</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">build_array</span><span class="PUNC">(</span><span class="NAME">duplicated_links</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">sorted_array.length</span><span class="PUNC">;</span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="COMM">// start at 1 to ignore the first item. One item can have the same name</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="COMM">// copy links and update links</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">counter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">col</span><span class="PUNC">=</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">col</span><span class="PUNC">&lt;</span><span class="NAME">sorted_array</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">;</span><span class="NAME">col</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">tmp_name</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">sorted_array</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">col</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">name</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                       </span><span class="COMM">// build the new file</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">file_path</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">sorted_array</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">col</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">filePath</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">my_file</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">File</span><span class="PUNC">(</span><span class="NAME">file_path</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">lastDot</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">file_path.lastIndexOf</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="STRN">"."</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">file_path_without_ext</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">file_path.substr</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">lastDot</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">extension</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">file_path.substr</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">lastDot</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">file_path.length</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="COMM">// check if the file exist</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">file_exist</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">while</span><span class="PUNC">(</span><span class="NAME">file_exist</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">new_file_path</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">file_path_without_ext</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"_"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">counter</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">extension</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">new_file</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">File</span><span class="PUNC">(</span><span class="NAME">new_file_path</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">new_file.exists</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                                </span><span class="NAME">file_exist</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="NAME">counter</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="COMM">// copy the file</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="NAME">my_file.copy</span><span class="PUNC">(</span><span class="NAME">new_file_path</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="COMM">// relink</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="NAME">sorted_array</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">col</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">relink</span><span class="PUNC">(</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">File</span><span class="PUNC">(</span><span class="NAME">new_file_path</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="COMM">// build repport</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="NAME">rapport_logger.info</span><span class="PUNC">(</span><span class="STRN">"l'image "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">tmp_name</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"></span><span class="WHIT">                                </span><span class="STRN">" a été dupliquée sous un nouveau nom: "</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">sorted_array</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">col</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">name</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">array_all_links</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">doc_package.links</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">array_all_links.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">current_link</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">array_all_links</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">is_valid</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">is_link_valid</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">current_link</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">results.array_of_ignored_picture</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                </span><span class="COMM">//modifie only a valid link</span><span class="WHIT"></span><span class="WHIT">                </span><span class="WHIT"></span><span class="WHIT">                </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">is_valid</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="COMM">// modifie only a link if I is used 1 time</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">use_number</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Document_tools.is_link_used_many_time</span><span class="PUNC">(</span><span class="NAME">array_all_links</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">doc_package</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">use_number</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="COMM">// process only JPG and PNG</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">current_link.linkType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"JPEG"</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">current_link.linkType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"Portable Network Graphics (PNG)"</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="COMM">// if PNG recoard as PSD</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">current_link.linkType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"Portable Network Graphics (PNG)"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">new_file_path</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Picture_tools.call_potoshop</span><span class="PUNC">(</span><span class="WHIT"></span><span class="WHIT">                                </span><span class="NAME">Photoshop_library.save_to_PSD_PS</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                                    </span><span class="PUNC">{</span><span class="NAME">file_path</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">encodeURI</span><span class="PUNC">(</span><span class="NAME">current_link.filePath</span><span class="PUNC">)</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                                </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                                </span><span class="NAME">rapport_logger.info</span><span class="PUNC">(</span><span class="STRN">"l'image "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">array_all_links</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">name</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"></span><span class="WHIT">                                </span><span class="STRN">" a été réenregistrée en psd"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                                </span><span class="COMM">// if JPEG record as tiff</span><span class="WHIT"></span><span class="WHIT">                                </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">new_file_path</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Picture_tools.call_potoshop</span><span class="PUNC">(</span><span class="WHIT"></span><span class="WHIT">                                </span><span class="NAME">Photoshop_library.save_to_TIFF_PS</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                                    </span><span class="PUNC">{</span><span class="NAME">file_path</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">encodeURI</span><span class="PUNC">(</span><span class="NAME">current_link.filePath</span><span class="PUNC">)</span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                                </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                                </span><span class="WHIT"></span><span class="WHIT">                                 </span><span class="NAME">rapport_logger.info</span><span class="PUNC">(</span><span class="STRN">"l'image "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">array_all_links</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">name</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"></span><span class="WHIT">                                </span><span class="STRN">" a été réenregistrée en tif"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                             </span><span class="COMM">// delete the old File</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">File</span><span class="PUNC">(</span><span class="NAME">current_link.filePath</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">remove</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="COMM">// relink</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="NAME">current_link.relink</span><span class="PUNC">(</span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">File</span><span class="PUNC">(</span><span class="NAME">new_file_path</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="COMM">//resampling</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">was_current_link_modified</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">resampling</span><span class="PUNC">(</span><span class="NAME">current_link</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rapport_logger</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">results.cibleBitmap</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">results.cibleRaster</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">results.isPictureNotPropAllowed</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">                            </span><span class="NAME">results.isSousEchantillonnage</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">results.isSurEchantillonnage</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">results.limitBitmap</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">results.limitRaster</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">was_current_link_modified</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="NAME">number_of_link_modified</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                            </span><span class="NAME">set_link_to_100</span><span class="PUNC">(</span><span class="NAME">current_link</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="NAME">rapport_logger.infoAlert</span><span class="PUNC">(</span><span class="STRN">"l'image "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">array_all_links</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">name</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"></span><span class="WHIT">                        </span><span class="STRN">" est utilisée plusieurs fois, aucun changement ne sera effectué sur cette image"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">number_of_link_modified</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">rapport_logger.info</span><span class="PUNC">(</span><span class="STRN">"le script n'a eu aucun effet, aucun changement n'a été apporté au document"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">doc_package.save</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">alert</span><span class="PUNC">(</span><span class="STRN">"le script est terminé"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="COMM">// the user click cancel script</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">alert</span><span class="PUNC">(</span><span class="STRN">"le script a été annulé"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">exit</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/** * this function open photoshop * @throws {Error} photoshop isn't installed **/</span><span class="WHIT"></span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">open_photoshop</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">  </span><span class="WHIT"></span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">mySpecifier</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">BridgeTalk.getSpecifier</span><span class="PUNC">(</span><span class="STRN">"photoshop"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">mySpecifier</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"photoshop n'est pas installé"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">     </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">     </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">BridgeTalk.isRunning</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="STRN">"photoshop"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myConfirm</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">confirm</span><span class="PUNC">(</span><span class="STRN">"voulez-vous démarrer photoshop?"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">myConfirm</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">BridgeTalk.launch</span><span class="PUNC">(</span><span class="STRN">"photoshop"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">alert</span><span class="PUNC">(</span><span class="STRN">"attendez que photoshop soit démarré, puis relancer le script"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">exit</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">else</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">exit</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">     </span><span class="PUNC">}</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/** * this function resize an image in photoshop * @param {Link} link_item the link to resize * @param {Log} rapport_logger the log to write witch changements will be applicated to the image * @param {Integer} target_res_bitmap the target resolution for the bitmap image (non raster) * @param {Integer} target_res_raster the target resolution for normal image * @param {Boolean} isPictureNotPropAllowed true if a link can be unproportionnal * @param {Boolean} is_under_sampling true if this function can reduce the resolution of an image * @param {Boolean} is_over_sampling true if this function can increase the resolution of an image * @param {Integer} limit_bitmap the minimum resolution of an bitmap image -> display an alert * @param {Integer} limit_raster the minimum resolution of an normal image -> display an alert **/</span><span class="WHIT"></span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">resampling</span><span class="PUNC">(</span><span class="NAME">link_item</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rapport_logger</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">target_res_bitmap</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">target_res_raster</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">isPictureNotPropAllowed</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">is_under_sampling</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">is_over_sampling</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">limit_bitmap</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">limit_raster</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">link_was_modified</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">target_resolution</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">target_limit</span><span class="PUNC">;</span><span class="WHIT">  </span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">is_image_prop</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Document_tools.is_link_proportionnal</span><span class="PUNC">(</span><span class="NAME">link_item</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">is_current_link_bitmap</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Picture_tools.is_image_bitmap</span><span class="PUNC">(</span><span class="NAME">link_item</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">file_path</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">link_item.filePath</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">image</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">link_item.parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">graphic</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">image.parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">try</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">             </span><span class="NAME">graphic.redefineScaling</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">catch</span><span class="PUNC">(</span><span class="NAME">ex</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"problème lors du rééchantillonnage. Une image a un bloc avec une échelle non admise"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">horizontal_scale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">image.absoluteHorizontalScale</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">vertical_scale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">image.absoluteVerticalScale</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">// the image in eps have not an effective resolution -> open in photoshop</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">array_effective_resolution</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">link_item.linkType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"EPS"</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">resolution</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Picture_tools.call_potoshop</span><span class="PUNC">(</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">Photoshop_library.get_resolution_PS</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">file_path</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">encodeURI</span><span class="PUNC">(</span><span class="NAME">file_path</span><span class="PUNC">)</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">array_effective_resolution</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">resolution</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">horizontal_scale</span><span class="PUNC">/</span><span class="NUMB">100</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">array_effective_resolution</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">resolution</span><span class="WHIT"> </span><span class="PUNC">/</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">vertical_scale</span><span class="PUNC">/</span><span class="NUMB">100</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">array_effective_resolution</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">image.effectivePpi</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">// if the link is not proportionnal use the lower resolution</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">effective_PPI</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">is_image_prop</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">array_effective_resolution</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">Tools.get_lower_element</span><span class="PUNC">(</span><span class="NAME">array_effective_resolution</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">// select target resolution and limit resolution</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">is_current_link_bitmap</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">target_resolution</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">target_res_bitmap</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">target_limit</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">limit_bitmap</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">target_resolution</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">target_res_raster</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">target_limit</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">limit_raster</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">// if an image is not prop and the user select image not proportionnal not allowed -> alert</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">isPictureNotPropAllowed</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">is_image_prop</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">rapport_logger.warnAlert</span><span class="PUNC">(</span><span class="STRN">"l'image "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">link_item.name</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"></span><span class="WHIT">            </span><span class="STRN">" est non proportionnelle, aucun changement ne sera apporté à cette illustration"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">link_was_modified</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">// if an image has  a to lower resolution alert and log</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">effective_PPI</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">target_limit</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">rapport_logger.warnAlert</span><span class="PUNC">(</span><span class="STRN">"l'image "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">link_item.name</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"></span><span class="WHIT">        </span><span class="STRN">" a une résolution en dessous de la limite spécifiée: "</span><span class="PUNC">+</span><span class="NAME">target_limit</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">is_under_sampling</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">effective_PPI</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">target_resolution</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">resample_method</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"ResampleMethod.BICUBICSHARPER"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">Picture_tools.call_potoshop</span><span class="PUNC">(</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">Photoshop_library.resampling_PS</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">file_path</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">encodeURI</span><span class="PUNC">(</span><span class="NAME">file_path</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">horizontal_scale</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">horizontal_scale</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">vertical_scale</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">vertical_scale</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">resolution</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">target_resolution</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">resample_method</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">resample_method</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">rapport_logger.info</span><span class="PUNC">(</span><span class="STRN">"l'image "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">link_item.name</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="STRN">" a été sous échantillonnée"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">link_was_modified</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">is_over_sampling</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">effective_PPI</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">target_resolution</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">resample_method</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">"ResampleMethod.BICUBICSMOOTHER"</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">Picture_tools.call_potoshop</span><span class="PUNC">(</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">Photoshop_library.resampling_PS</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">file_path</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">encodeURI</span><span class="PUNC">(</span><span class="NAME">file_path</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">horizontal_scale</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">horizontal_scale</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">vertical_scale</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">vertical_scale</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">resolution</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">target_resolution</span><span class="PUNC">,</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">resample_method</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="NAME">resample_method</span><span class="WHIT"></span><span class="WHIT">                </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">            </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">rapport_logger.info</span><span class="PUNC">(</span><span class="STRN">"l'image "</span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">link_item.name</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="STRN">" a été sur échantillonnée"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">link_was_modified</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT">   </span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">link_was_modified</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/*** function to set a link to 100% in the InDesign document, the unproportionnal link are resized and set to 100%* @param {Link}  link_item the link item to process* @throws {Error} the link as an incorrect statuts if the status is not normal**/</span><span class="WHIT"></span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">set_link_to_100</span><span class="PUNC">(</span><span class="NAME">link_item</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">link_item.status</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">status</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">LinkStatus.LINK_OUT_OF_DATE</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">link_item.update</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">link_item.status</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">LinkStatus.NORMAL</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"le lien "</span><span class="PUNC">+</span><span class="NAME">link_item.name</span><span class="PUNC">+</span><span class="STRN">" a un statut incorrect"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">Document_tools.is_link_proportionnal</span><span class="PUNC">(</span><span class="NAME">link_item</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">link_item.parent.absoluteHorizontalScale</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">99.9</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">link_item.parent.absoluteHorizontalScale</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NUMB">100.1</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">link_item.parent.absoluteHorizontalScale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">link_item.parent.absoluteVerticalScale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">link_item.parent.absoluteHorizontalScale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">link_item.parent.absoluteVerticalScale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">100</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/*** this function check if a link is valid (statut = normal, not in array of ignored file, Tiff, JPEG, PNG, EPS type raster, PSD)* @param {Link} link_item the link element* @param {Array} the array of ignored file* @return true if the link is valid**/</span><span class="WHIT"></span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">is_link_valid</span><span class="PUNC">(</span><span class="NAME">link_item</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">array_of_ignored_picture</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">link_item.status</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NAME">LinkStatus.NORMAL</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">// array of file without space and special char</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">Tools.is_in_array</span><span class="PUNC">(</span><span class="NAME">link_item.name</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">array_of_ignored_picture</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">link_item.linkType</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">"TIFF"</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">link_item.linkType</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">"JPEG"</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">link_item.linkType</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">"Portable Network Graphics (PNG)"</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">link_item.linkType</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">"EPS"</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">link_item.linkType</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="STRN">"Photoshop"</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">link_item.linkType</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"EPS"</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">eps_img</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">File</span><span class="PUNC">(</span><span class="NAME">link_item.filePath</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">Picture_tools.is_raster_eps</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">eps_img</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/*** this function a build a sorted array with duplicated links* @example Array [Array_links, Array_links]* @param {Array} duplicated_links, the array to sort* @return {Array} array the array who contains one array per links with the same name**/</span><span class="WHIT"></span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">build_array</span><span class="PUNC">(</span><span class="NAME">duplicated_links</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">array</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">while</span><span class="PUNC">(</span><span class="NAME">duplicated_links.length</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">arr</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Array</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">current_item</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">duplicated_links</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">arr.push</span><span class="PUNC">(</span><span class="NAME">current_item</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">duplicated_links.splice</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">while</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">duplicated_links.length</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">duplicated_links</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">filePath</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">current_item.filePath</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">arr.push</span><span class="PUNC">(</span><span class="NAME">duplicated_links</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">duplicated_links.splice</span><span class="PUNC">(</span><span class="NAME">i</span><span class="PUNC">,</span><span class="NUMB">1</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">                    </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">             </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">             </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">                </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">             </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">       </span><span class="NAME">array.push</span><span class="PUNC">(</span><span class="NAME">arr</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">array</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span></pre></body></html>