<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="TOKN">﻿</span><span class="TOKN">#</span><span class="NAME">include</span><span class="WHIT"> </span><span class="STRN">"Tools.jsx"</span><span class="WHIT"></span><span class="COMM">/*** Document_tools class* @class &lt;b>Document_tools&lt;/b> a class to deal with images. Contains static methods* @author Bastien Eichenberger* @requires Tools class* @requires Photoshop_library**/</span><span class="WHIT"></span><span class="KEYW">function</span><span class="WHIT"> </span><span class="NAME">Document_tools</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/** * function who return true if one link is out of date * @param {Indesign Document} doc the indesign document * @return {Boolean} link_statut true if a link is out of date, then false **/</span><span class="WHIT"></span><span class="NAME">Document_tools.check_outOfDate_link</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">doc</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">link_statut</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">doc.links.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">current_link</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">doc.links</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">current_link.status</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">LinkStatus.LINK_OUT_OF_DATE</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">link_statut</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">link_statut</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/** * function who return true if one link is missing * @return {Boolean} link_statut true, if a link is missing then false **/</span><span class="WHIT"></span><span class="NAME">Document_tools.check_is_missing_link</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">doc</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">link_statut</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">doc.links.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">current_link</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">doc.links</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">current_link.status</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">LinkStatus.LINK_MISSING</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">link_statut</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">link_statut</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/** * function who package a document and his link * @param {Indesign Document} doc the doc to package * @param {String} directories_path_str the path where to store the new document * @return {String} new_doc_file the new doc path * @throw {Error} if the package function occured an error **/</span><span class="WHIT"></span><span class="NAME">Document_tools.save_with_package</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">doc</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">directories_path_str</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">result_package</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">current_date</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Date</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">folder_package</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Folder</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">directories_path_str</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">folder_package.exists</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">folder_package.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">doc_file</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">doc.fullName</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">current_folder</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Folder</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">folder_package</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"/"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">Tools.format_date</span><span class="PUNC">(</span><span class="NAME">current_date</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"_"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">Tools.format_time</span><span class="PUNC">(</span><span class="NAME">current_date</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"__"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">doc.name</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">	</span><span class="NAME">current_folder.create</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="COMM">/**bool packageForPrint (to: File, copyingFonts: bool, copyingLinkedGraphics: bool, copyingProfiles: bool, updatingGraphics: bool,       *  includingHiddenLayers: bool, ignorePreflightErrors: bool, creatingReport: bool[, versionComments: string][, forceSave: bool=false])      **/</span><span class="WHIT"></span><span class="WHIT">    </span><span class="NAME">result_package</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">doc.packageForPrint</span><span class="PUNC">(</span><span class="NAME">current_folder</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="PUNC">!</span><span class="NAME">result_package</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">throw</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Error</span><span class="PUNC">(</span><span class="STRN">"il y a eu un problème lors de l'assemblage"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">current_folder</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">"/"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">doc.name</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/** * function who check if the same imported file is used many time (image, PDF) * @param {Link} link_item the link item * @param {Indesign Document} doc_to_check the indesign document to check * @return {Integer} counter The number of times the link is used **/</span><span class="WHIT"></span><span class="NAME">Document_tools.is_link_used_many_time</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">link_item</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">doc_to_check</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">array_all_links</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">doc_to_check.links</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">counter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">&lt;</span><span class="NAME">array_all_links.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">current_link</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">array_all_links</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">link_item.filePath</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">current_link.filePath</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">            </span><span class="NAME">counter</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">        </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">counter</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/** * function who check if a link is proportionnal or not * @param {Link} link_item the link item * @return {Boolean} is_prop true if the link is proportionnal **/</span><span class="WHIT"></span><span class="NAME">Document_tools.is_link_proportionnal</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">link_item</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">is_prop</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myImage</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">link_item.parent</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myHorScale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">myImage.absoluteHorizontalScale</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">myVerScale</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">Math.abs</span><span class="PUNC">(</span><span class="NAME">myImage.absoluteVerticalScale</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">Math.round</span><span class="PUNC">(</span><span class="NAME">myHorScale</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">Math.round</span><span class="PUNC">(</span><span class="NAME">myVerScale</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">is_prop</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">else</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">        </span><span class="NAME">is_prop</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="PUNC">}</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">is_prop</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span><span class="COMM">/** * function to get the filepath from a link item * @param {Link} link_item the link item * @return {String} my_path the filepath of the element in the link item **/</span><span class="WHIT"></span><span class="NAME">Document_tools.get_file_path_from_link</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">link_item</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">file_object</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">File</span><span class="PUNC">(</span><span class="NAME">link_item.filePath</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">my_path</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">file_object.fsName</span><span class="PUNC">;</span><span class="WHIT"></span><span class="WHIT">    </span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">my_path</span><span class="PUNC">;</span><span class="WHIT"></span><span class="PUNC">}</span><span class="WHIT"></span></pre></body></html>